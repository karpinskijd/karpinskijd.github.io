<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tears of the Kingdom Armor Tracker</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>

    <h1>Tears of the Kingdom Armor Tracker</h1>

    <div id="armor-sets"></div>

    <div id="total-cost"></div>

    <div id="total-materials">No materials required.</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script>
        let armorSets = {};
        let selectedPieces = {};
        let selectedLevels = {};
        let debounceTimer;

        function loadCheckboxStates() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach((checkbox) => {
                const isChecked = localStorage.getItem(checkbox.id) === 'true';
                checkbox.checked = isChecked;

                // Check if the checkbox is Include Piece and update level checkboxes accordingly
                if (checkbox.classList.contains('include-piece-checkbox')) {
                    const [armorSetName, piece] = checkbox.value.split('-');
                    const levelCheckboxes = document.querySelectorAll(`.armor-piece-fieldset input[type="checkbox"][value^="${armorSetName}-${piece}-"]`);
                    levelCheckboxes.forEach((levelCheckbox) => {
                        levelCheckbox.disabled = !isChecked;
                    });

                    // Display or hide materials list based on Include Piece checkbox state
                    const materialsList = checkbox.parentElement.parentElement.querySelectorAll('.materials-list');
                    materialsList.forEach((list) => {
                        list.style.display = isChecked ? 'block' : 'none';
                    });
                }
            });

            // Trigger the change event to ensure correct initialization
            const changeEvent = new Event('change');
            checkboxes.forEach((checkbox) => checkbox.dispatchEvent(changeEvent));
        }

        Papa.parse('materials.csv', {
            header: true,
            download: true,
            dynamicTyping: true,
            complete: function (results) {
                armorSets = results.data.reduce((acc, set) => {
                    const armorSetName = set.SetName;
                    const piece = set.Piece;
                    const level = set.Level;
                    const material = set.Material;
                    const quantity = set.Quantity;

                    if (armorSetName && piece && level && material && quantity) {
                        if (!acc[armorSetName]) {
                            acc[armorSetName] = { pieces: {} };
                        }

                        if (!acc[armorSetName].pieces[piece]) {
                            acc[armorSetName].pieces[piece] = { levels: {} };
                        }

                        if (!acc[armorSetName].pieces[piece].levels[level]) {
                            acc[armorSetName].pieces[piece].levels[level] = { materials: {} };
                        }

                        if (!acc[armorSetName].pieces[piece].levels[level].materials[material]) {
                            acc[armorSetName].pieces[piece].levels[level].materials[material] = 0;
                        }

                        acc[armorSetName].pieces[piece].levels[level].materials[material] += quantity;
                    }

                    return acc;
                }, {});

                populateCheckboxes();
                loadCheckboxStates();
            }
        });

        document.addEventListener('change', function (event) {
            const target = event.target;

            if (target.classList.contains('include-piece-checkbox') || target.type === 'checkbox') {
                updateSelectedItems();
                if (target.type === 'checkbox') {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => {
                        updateLevelCheckboxState();
                    }, 200); // Adjust the delay as needed
                }
            }
        });

        function saveCheckboxStates() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach((checkbox) => {
                localStorage.setItem(checkbox.id, checkbox.checked);
            });
        }

        function debouncedUpdateLevelCheckboxState() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                updateLevelCheckboxState();
            }, 200); // Adjust the delay as needed
        }

        function updateCost() {
            let totalCost = 0;

            const includePieceCheckboxes = document.querySelectorAll('.include-piece-checkbox:checked');
            const levelCheckboxes = document.querySelectorAll('.armor-piece-fieldset input[type="checkbox"]:checked');

            // Calculate cost for Include Piece checkboxes
            totalCost += includePieceCheckboxes.length * 760;

            // Calculate cost based on checked level checkboxes
            levelCheckboxes.forEach((checkbox) => {
                const [armorSetName, piece, level] = checkbox.value.split('-');
                switch (level) {
                    case '1':
                        totalCost -= 10;
                        break;
                    case '2':
                        totalCost -= 50;
                        break;
                    case '3':
                        totalCost -= 200;
                        break;
                    case '4':
                        totalCost -= 500;
                        break;
                    default:
                        break;
                }
            });

            // Display the total cost only if there are Include Piece checkboxes checked
            const costContainer = document.getElementById('total-cost');
            costContainer.textContent = includePieceCheckboxes.length > 0 ? `Total cost: ${totalCost} Rupees` : '';
        }

        function updateLevelCheckboxState() {
            const levelCheckboxes = document.querySelectorAll('.armor-piece-fieldset input[type="checkbox"]');
            const includePieceCheckboxes = document.querySelectorAll('.include-piece-checkbox:checked');

            const includePieceChecked = includePieceCheckboxes.length > 0;

            levelCheckboxes.forEach((checkbox) => {
                const [armorSetName, piece, level] = checkbox.value.split('-');

                // Disable level checkboxes if their respective Include Piece checkbox is not checked
                checkbox.disabled = !includePieceChecked || !document.querySelector(`.include-piece-checkbox[value="${armorSetName}-${piece}"]:checked`);

                // Uncheck all level checkboxes when Include Piece is unchecked
                if (!includePieceChecked && checkbox.checked) {
                    checkbox.checked = false;
                }

                const materialsLists = checkbox.parentElement.querySelectorAll('.materials-list');
				materialsLists.forEach((list) => {
					list.style.display = 'block';
				});
            });

            const includePieceCheckbox = document.querySelectorAll('.include-piece-checkbox');
            includePieceCheckbox.forEach((checkbox) => {
                checkbox.disabled = false; // Ensure that Include Piece checkbox is never disabled
            });

            // Check if level 2, level 3, or level 4 is checked and update preceding levels accordingly
            levelCheckboxes.forEach((checkbox) => {
                const [armorSetName, piece, level] = checkbox.value.split('-');

                if (level && checkbox.checked) {
                    switch (level) {
                        case '2':
                            document.querySelector(`.armor-piece-fieldset input[type="checkbox"][value="${armorSetName}-${piece}-1"]`).checked = true;
                            break;
                        case '3':
                            document.querySelector(`.armor-piece-fieldset input[type="checkbox"][value="${armorSetName}-${piece}-1"]`).checked = true;
                            document.querySelector(`.armor-piece-fieldset input[type="checkbox"][value="${armorSetName}-${piece}-2"]`).checked = true;
                            break;
                        case '4':
                            document.querySelector(`.armor-piece-fieldset input[type="checkbox"][value="${armorSetName}-${piece}-1"]`).checked = true;
                            document.querySelector(`.armor-piece-fieldset input[type="checkbox"][value="${armorSetName}-${piece}-2"]`).checked = true;
                            document.querySelector(`.armor-piece-fieldset input[type="checkbox"][value="${armorSetName}-${piece}-3"]`).checked = true;
                            break;
                        default:
                            break;
                    }
                }
            });

            displayTotalMaterials();
            updateSelectedItems();
            updateCost();
        }

        function populateCheckboxes() {
            const armorSetsContainer = document.getElementById('armor-sets');

            for (const armorSetName in armorSets) {
                const armorSetDetails = document.createElement('details');
                armorSetDetails.classList.add('armor-set-details');

                const armorSetSummary = document.createElement('summary');
                armorSetSummary.textContent = armorSetName;

                const contentContainer = document.createElement('div');

                for (const piece in armorSets[armorSetName].pieces) {
                    const pieceFieldset = document.createElement('fieldset');
                    pieceFieldset.classList.add('armor-piece-fieldset');
                    pieceFieldset.innerHTML = `<legend>${piece}</legend>`;

                    const checkboxContainer = document.createElement('div');
                    checkboxContainer.classList.add('checkbox-container');

                    const levelContainer = document.createElement('div');

                    for (const level in armorSets[armorSetName].pieces[piece].levels) {
                        const levelFieldset = document.createElement('fieldset');
                        levelFieldset.classList.add('armor-piece-fieldset');
                        levelFieldset.innerHTML = `<legend>Level ${level}</legend>`;

                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.name = 'armor-set';
                        checkbox.value = `${armorSetName}-${piece}-${level}`;
                        checkbox.id = `checkbox-${armorSetName}-${piece}-${level}`;
                        checkbox.disabled = true; // Start with Level checkboxes disabled
                        checkbox.addEventListener('change', () => {
                            updateSelectedItems();
                            debouncedUpdateLevelCheckboxState();
                        });

                        const materialsList = document.createElement('ul');
                        materialsList.classList.add('materials-list');

                        for (const material in armorSets[armorSetName].pieces[piece].levels[level].materials) {
                            const quantity = armorSets[armorSetName].pieces[piece].levels[level].materials[material];
                            const materialItem = document.createElement('li');
                            materialItem.classList.add('material-item');
                            materialItem.textContent = `${material}: ${quantity}`;
                            materialsList.appendChild(materialItem);
                        }

                        levelFieldset.appendChild(checkbox);
                        levelFieldset.appendChild(materialsList);
                        checkboxContainer.appendChild(levelFieldset);
                    }

                    checkboxContainer.appendChild(levelContainer);

                    const includePieceCheckbox = document.createElement('input');
                    includePieceCheckbox.type = 'checkbox';
                    includePieceCheckbox.classList.add('include-piece-checkbox');
                    includePieceCheckbox.value = `${armorSetName}-${piece}`;
                    includePieceCheckbox.id = `include-piece-checkbox-${armorSetName}-${piece}`;
                    includePieceCheckbox.addEventListener('change', () => {
                        updateSelectedItems();
                        debouncedUpdateLevelCheckboxState();

                        const levelCheckboxes = checkboxContainer.querySelectorAll('input[type="checkbox"]');
                        levelCheckboxes.forEach((levelCheckbox) => {
                            levelCheckbox.disabled = !includePieceCheckbox.checked;
                        });

                        const materialsList = checkboxContainer.querySelector('.materials-list');
                        materialsList.style.display = includePieceCheckbox.checked ? 'block' : 'none';
                    });

                    const levelCheckboxes = document.querySelectorAll('.armor-piece-fieldset input[type="checkbox"]');
                    levelCheckboxes.forEach((checkbox) => {
                        checkbox.addEventListener('change', () => {
                            updateSelectedItems();
                            debouncedUpdateLevelCheckboxState();
                        });
                    });

                    checkboxContainer.appendChild(includePieceCheckbox);

                    pieceFieldset.appendChild(checkboxContainer);
                    contentContainer.appendChild(pieceFieldset);
                }

                armorSetDetails.appendChild(armorSetSummary);
                armorSetDetails.appendChild(contentContainer);
                armorSetsContainer.appendChild(armorSetDetails);

                const totalMaterialsContainer = document.createElement('div');
                totalMaterialsContainer.id = 'total-materials';
                document.body.appendChild(totalMaterialsContainer);
            }
        }

        function updateSelectedItems() {
            selectedPieces = {};
            selectedLevels = {};
            const checkboxes = document.querySelectorAll('.include-piece-checkbox:checked, .armor-piece-fieldset input:checked');

            checkboxes.forEach((checkbox) => {
                const [armorSetName, piece, level] = checkbox.value.split('-');

                if (level) {
                    if (!selectedLevels[armorSetName]) {
                        selectedLevels[armorSetName] = { levels: {} };
                    }

                    if (!selectedLevels[armorSetName].levels[piece]) {
                        selectedLevels[armorSetName].levels[piece] = {};
                    }

                    selectedLevels[armorSetName].levels[piece][level] = true;
                } else {
                    if (!selectedPieces[armorSetName]) {
                        selectedPieces[armorSetName] = { pieces: {} };
                    }

                    selectedPieces[armorSetName].pieces[piece] = true;
                }
            });

            displayTotalMaterials();
        }

        function displayTotalMaterials() {
			const totalMaterialsContainer = document.getElementById('total-materials');
			totalMaterialsContainer.innerHTML = '';

			const includePieceCheckboxes = document.querySelectorAll('.include-piece-checkbox:checked');

			const totalMaterialsList = document.createElement('ul');
			totalMaterialsList.classList.add('materials-list', 'three-columns'); // Apply three-column style here

			const totalMaterialsMap = new Map();

			// Populate the map with materials and quantities
			includePieceCheckboxes.forEach((includePieceCheckbox) => {
				const [armorSetName, piece] = includePieceCheckbox.value.split('-');

				for (const level in armorSets[armorSetName].pieces[piece].levels) {
					for (const material in armorSets[armorSetName].pieces[piece].levels[level].materials) {
						const quantity = armorSets[armorSetName].pieces[piece].levels[level].materials[material];

						if (!totalMaterialsMap.has(material)) {
							totalMaterialsMap.set(material, 0);
						}

						if (!selectedLevels[armorSetName]?.levels[piece]?.[level]) {
							totalMaterialsMap.set(material, totalMaterialsMap.get(material) + quantity);
						}
					}
				}
			});

			// Sort the map alphabetically by material name
			const sortedMaterialsMap = new Map([...totalMaterialsMap.entries()].sort());

			// Create list items for each material entry (exclude materials with quantity 0)
			sortedMaterialsMap.forEach((quantity, material) => {
				if (quantity > 0) {
					const materialItem = document.createElement('li');
					materialItem.classList.add('material-item');
					materialItem.textContent = `${material}: ${quantity}`;
					totalMaterialsList.appendChild(materialItem);
				}
			});

			totalMaterialsContainer.appendChild(totalMaterialsList);

			// Check if the list is empty and display "No materials required"
			if (totalMaterialsList.children.length === 0) {
				totalMaterialsContainer.textContent = 'No materials required.';
			}

			updateCost();
		}

    </script>

</body>

</html>
